name: Deploy via SSH

on:
 push:
  branches:
  - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Test SSH Connection (with logs)
        run: |
         echo "Attempting SSH connection to $SSH_USER@$SSH_HOST"
         sshpass -p "$SSH_PASSWORD" ssh -vvv -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "echo âœ… SSH connection successful!"
        env: 
         SSH_USER: ${{ secrets.USER }}
         SSH_PASSWORD: ${{ secrets.PASSWORD }}
         SSH_HOST: ${{ secrets.HOST }}
      - name: Rebuild and Restart Docker Container
        run: |
          echo "Attempting SSH connection to $SSH_USER@$SSH_HOST"
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'EOF'
            cd /path/to/your/project || exit 1
            echo 'ðŸ› ï¸ Building Docker image...'
            docker build -t loneApp .
            echo 'ðŸ›‘ Stopping old container (if any)...'
            docker stop loneApp || true
            docker rm loneApp || true
            echo 'ðŸš€ Running Docker container on port 80...'
            docker run -d --name loneApp -p 80:80 loneApp
          EOF
        env: 
          SSH_USER: ${{ secrets.USER }}
          SSH_PASSWORD: ${{ secrets.PASSWORD }}
          SSH_HOST: ${{ secrets.HOST }}

